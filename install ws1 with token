# =========================================
# Workspace ONE Install + Enrollment Logging
# =========================================

# === Device Info ===
$serialNumber = (Get-CimInstance Win32_BIOS).SerialNumber
$fullUser = (Get-CimInstance Win32_ComputerSystem).UserName
$userName = if ($fullUser -and $fullUser.Contains("\")) { $fullUser.Split("\")[-1] } else { $fullUser }

# === Desktop log file ===
$desktopPath = [Environment]::GetFolderPath("Desktop")
$errorLogTxt = Join-Path $desktopPath "WorkspaceONE_Enroll_Error.txt"
$msiLog     = "$env:TEMP\WorkspaceONE.log"

Write-Host ""
Write-Host "üíª Masukan Token untuk Device" -ForegroundColor Cyan
Write-Host "-----------------------------"
Write-Host "üî¢ Serial Number : $serialNumber"
Write-Host "üë§ Active User   : $userName"
Write-Host ""

# === Token Input (visible) ===
$token = Read-Host "üîë Masukkan Token Enrollment"
if ([string]::IsNullOrWhiteSpace($token)) {
    Write-Host "‚ùå Token tidak boleh kosong." -ForegroundColor Red
    Exit 1
}

# === Download MSI ===
$downloadUrl = "https://packages.omnissa.com/wsone/AirwatchAgent.msi"
$targetDir = "C:\Temp"
$msiPath   = "$targetDir\AirwatchAgent.msi"

if (-not (Test-Path $targetDir)) {
    New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
}

Write-Host "‚¨áÔ∏è  Download Workspace ONE..." -ForegroundColor Cyan
Invoke-WebRequest -Uri $downloadUrl -OutFile $msiPath -Headers @{ "User-Agent"="Mozilla/5.0" }

# === Install MSI ===
Write-Host "[...] Installing Workspace ONE" -ForegroundColor Yellow

Copy-Item $msiPath "C:\Windows\Temp\" -Force
$msiArgs = "/i C:\Windows\Temp\AirwatchAgent.msi /qn ENROLL=Y SERVER=ds510.awmdm.sg LGName=id_seagroup Token=$token ASSIGNTOLOGGEDINUSER=Y DOWNLOADWSBUNDLE=FALSE /LOG `"$msiLog`""

$process = Start-Process msiexec.exe -ArgumentList $msiArgs -Wait -PassThru
$exitCode = $process.ExitCode

# === Analyze Result ===
if ($exitCode -ne 0) {

    Write-Host "‚ùå Installation / Enrollment FAILED (ExitCode: $exitCode)" -ForegroundColor Red

    # Ambil baris error dari log MSI
    $errorLines = Select-String -Path $msiLog -Pattern "error|fail|return value 3" -CaseSensitive:$false

    $content = @()
    $content += "Workspace ONE Enrollment FAILED"
    $content += "=============================="
    $content += "Serial Number : $serialNumber"
    $content += "User          : $userName"
    $content += "Exit Code     : $exitCode"
    $content += "Log File      : $msiLog"
    $content += ""
    $content += "Error Details:"
    $content += "--------------"

    if ($errorLines) {
        $content += $errorLines.Line
    } else {
        $content += "Tidak ditemukan error spesifik di log."
    }

    $content | Out-File -FilePath $errorLogTxt -Encoding UTF8

    Write-Host "üìÑ Error log dibuat di Desktop:" -ForegroundColor Yellow
    Write-Host "   $errorLogTxt"
    Exit 1
}

# === Success ===
Write-Host "[‚úì] Installation completed successfully." -ForegroundColor Green
Write-Host "[‚úì] Waiting for enrollment..." -ForegroundColor Green
